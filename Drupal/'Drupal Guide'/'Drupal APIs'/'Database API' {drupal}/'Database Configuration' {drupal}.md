[https://www.drupal.org/docs/8/api/database-api/database-configuration](https://www.drupal.org/docs/8/api/database-api/database-configuration)

Основным средством установления соединения с базой данных является массив $databases в файле settings.php. Как следует из названия, $databases позволяет определить несколько подключений к БД. Он также поддерживает определение нескольких целей. Соединение с БД не открывается (объект соединения не создается) до тех пор, пока какой-нибудь кусок кода не попытается выполнить запрос к этой БД в первый раз.

**Connection key**

```php
$databases['default'] // The database connection.
```

Ключ соединения - это уникальный идентификатор для данного соединения с БД. Ключ соединения должен быть уникальным для данного сайта, и всегда должно быть соединение "по умолчанию", которое будет основным Drupal БД. На большинстве сайтов это будет единственное определенное соединение.
**Target**

```php
$databases['default']['default'] // The database target.
```

Данный ключ соединения должен иметь одну или несколько целей. Цель - это база данных, которая может быть использована, если она доступна. Целевой объект "default" всегда должен быть определен для каждого ключа соединения. Если запрашиваемая цель не определена, система без предупреждений вернется к "default".

Основное назначение целей это primary/replica репликации. "default" целью является основной SQL сервер. Затем может быть определена одна или более "replica" целей (обратите внимание, что в некоторых ситуациях "replica" является единственной действительной альтернативной целью, например, в [статических запросах](https://www.drupal.org/node/310072#query-options)). Запросы, которые помечены флажком "пытаться и использовать replica сервер", если он доступен, будут пытаться получить доступ к цели "replica". Если он доступен, то соединение будет открыто (если его еще нет), и запрос будет выполнен на replica сервере. Если нет, то запрос будет выполнен на "default" (primary) сервере. Это позволяет сделать прозрачный откат, так что код может быть написан, чтобы воспользоваться преимуществами сервера реплик, если он доступен, но все равно будет выполняться без каких-либо модификаций.

**$databases syntax**

Массив $databases представляет собой вложенный массив, состоящий как минимум из трех уровней. Первый уровень определяет ключи базы данных. Второй определяет цели базы данных. Значением каждой цели является информация о соединении для этого ключа/цели. Немного примеров должны сделать это более понятным.

```php
$databases['default']['default'] = array(
  'driver' => 'mysql',
  'database' => 'drupaldb',
  'username' => 'username',
  'password' => 'secret',
  'host' => 'localhost',
);
```

Вышеуказанный массив $databases определяет один ключ соединения ("default"), с одной целью ("default"). Это соединение использует базу данных MySQL (ключ "driver") на localhost под названием "drupaldb" с именем пользователя "username" и паролем "secret". Приведенный выше пример является типичным для установки Drupal на одном сервере SQL и будет достаточен для подавляющего большинства сайтов.

Для primary/replica конфигурации можно определить следующее:

```php
$databases['default']['default'] = array(
  'driver' => 'mysql',
  'database' => 'drupaldb1',
  'username' => 'username',
  'password' => 'secret',
  'host' => 'dbserver1',
);
$databases['default']['replica'][] = array(
  'driver' => 'mysql',
  'database' => 'drupaldb2',
  'username' => 'username',
  'password' => 'secret',
  'host' => 'dbserver2',
);
$databases['default']['replica'][] = array(
  'driver' => 'mysql',
  'database' => 'drupaldb3',
  'username' => 'username',
  'password' => 'secret',
  'host' => 'dbserver3',
);
```

Это определение определяет один сервер "default" и два сервера "replic". Обратите внимание, что ключ "replica" - это массив. Если какая-либо цель определена как массив информации о соединении, один из определенных серверов будет выбран случайным образом для этой цели при каждом запросе страницы. То есть, при запросе одной страницы все запросы реплики будут отправляться на dbserver2, а при следующем запросе все они могут быть отправлены на dbserver3.

```php
$databases['default']['default'] = array(
  'driver' => 'mysql',
  'database' => 'drupaldb1',
  'username' => 'username',
  'password' => 'secret',
  'host' => 'dbserver1',
);
$databases['extra']['default'] = array(
  'driver' => 'sqlite',
  'database' => 'files/extradb.sqlite',
);
```

Эта конфигурация определяет одну главную Drupal БД и одну дополнительную БД с маркировкой "extra", которая использует SQLite. Обратите внимание, что информация о соединении SQLite структурирована иначе, чем MySQL. Каждый драйвер может иметь свою конфигурацию в зависимости от того, что для него подходит.

Помните, что независимо от того, сколько соединений вы определите, Drupal не будет открывать соединение с этой БД до тех пор, пока она не будет фактически использована.

# PDO обязателен

Так как библиотека PHP [PDO](http://www.php.net/pdo) теперь требуется для уровня базы данных Drupal, то для запуска Drupal вам понадобится хосинг план, включающий ее.

# PDO Options

[Опции PDO](http://www.php.net/manual/en/pdo.constants.php) и [Опции PDO, специфичные для драйверов](http://php.net/manual/en/pdo.drivers.php) можно указать в массиве баз данных с ключом 'pdo' примерно так:

```php
$databases['default']['default'] = array(
  'driver' => 'mysql',
  'database' => 'drupaldb',
  'username' => 'username',
  'password' => 'secret',
  'host' => 'dbserver1',
  'pdo' => array(PDO::ATTR_TIMEOUT => 2.0, PDO::MYSQL_ATTR_COMPRESS => 1),
);
```

{ - done - 2021-02-11 }